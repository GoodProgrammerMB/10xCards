# REST API Plan

## 1. Resources

- **Users**: Represents the users of the system. Maps to the `Users` table which stores user credentials and metadata.
- **Flashcards**: Represents flashcards created by users or generated by the AI. Maps to the `Flashcards` table. Includes text for the front and back, along with a source indicator.
- **Generations**: Represents instances where the AI generates flashcard suggestions. Maps to the `Generations` table and includes details such as model used, count of generated cards, and validation of the source text length.
- **Generation_Error_Logs**: Captures errors related to AI generation processes. Maps to the `Generation_Error_Logs` table (typically for internal or admin use).

## 2. Endpoints

### Users Endpoints

1. **POST /users/register**
   - **Description**: Register a new user.
   - **Request Payload**:
     ```json
     {
       "email": "string",
       "password": "string"
     }
     ```
   - **Response Payload**:
     ```json
     {
       "id": "integer",
       "email": "string",
       "created_at": "datetime"
     }
     ```
   - **Status Codes**:
     - 201 Created
     - 400 Bad Request (e.g., if email is already in use or if validation fails)

2. **POST /users/login**
   - **Description**: Authenticate a user and return a JWT token.
   - **Request Payload**:
     ```json
     {
       "email": "string",
       "password": "string"
     }
     ```
   - **Response Payload**:
     ```json
     {
       "token": "string",
       "user": {
         "id": "integer",
         "email": "string"
       }
     }
     ```
   - **Status Codes**:
     - 200 OK
     - 401 Unauthorized (invalid credentials)

3. **GET /users/me**
   - **Description**: Retrieve the profile of the currently authenticated user.
   - **Authentication**: Requires a valid JWT token in the Authorization header.
   - **Response Payload**:
     ```json
     {
       "id": "integer",
       "email": "string",
       "created_at": "datetime",
       "updated_at": "datetime"
     }
     ```
   - **Status Codes**:
     - 200 OK
     - 401 Unauthorized

### Flashcards Endpoints

1. **GET /flashcards**
   - **Description**: Retrieve a paginated list of flashcards for the authenticated user.
   - **Query Parameters** (optional):
     - `page` (integer, default: 1)
     - `pageSize` (integer, default: 20)
     - `sortBy` (e.g., created_at)
     - `filter` (e.g., by source: manual, ai-full, or ai-edited)
   - **Response Payload**:
     ```json
     {
       "data": [
         {
           "id": "integer",
           "front": "string",
           "back": "string",
           "source": "string",
           "created_at": "datetime",
           "updated_at": "datetime"
         }
       ],
       "pagination": {
         "page": "integer",
         "pageSize": "integer",
         "totalPages": "integer",
         "totalItems": "integer"
       }
     }
     ```
   - **Status Codes**:
     - 200 OK
     - 401 Unauthorized

2. **GET /flashcards/{id}**
   - **Description**: Retrieve details of a specific flashcard by its ID.
   - **Response Payload**:
     ```json
     {
       "id": "integer",
       "front": "string",
       "back": "string",
       "source": "string",
       "created_at": "datetime",
       "updated_at": "datetime"
     }
     ```
   - **Status Codes**:
     - 200 OK
     - 404 Not Found
     - 401 Unauthorized
2.5. **POST /flashcards/batch**
   - **Description**: Create multiple flashcards at once, supporting both manual and AI-generated cards.
   - **Request Payload**:
     ```json
     {
       "flashcards": [
         {
           "front": "string (max 200 chars)",
           "back": "string (max 500 chars)",
           "source": "string (one of: ai-full, ai-edited, manual)",
           "generation_id": "integer (optional, required for ai-full and ai-edited)"
         }
       ]
     }
     ```
   - **Response Payload**:
     ```json
     {
       "data": [
         {
           "id": "integer",
           "front": "string",
           "back": "string",
           "source": "string",
           "generation_id": "integer",
           "created_at": "datetime",
           "updated_at": "datetime"
         }
       ],
       "summary": {
         "total_created": "integer",
         "total_failed": "integer"
       }
     }
     ```
   - **Status Codes**:
     - 201 Created
     - 400 Bad Request (if any validations fail)
     - 401 Unauthorized
     - 207 Multi-Status (partial success)

3. **POST /flashcards**
   - **Description**: Create a new flashcard manually.
   - **Request Payload**:
     ```json
     {
       "front": "string (max 200 chars)",
       "back": "string (max 500 chars)",
       "source": "manual"
     }
     ```
   - **Response Payload**:
     ```json
     {
       "id": "integer",
       "front": "string",
       "back": "string",
       "source": "manual",
       "created_at": "datetime",
       "updated_at": "datetime"
     }
     ```
   - **Status Codes**:
     - 201 Created
     - 400 Bad Request (if validations fail)
     - 401 Unauthorized

4. **PUT /flashcards/{id}**
   - **Description**: Update an existing flashcard.
   - **Request Payload** (all fields optional if partial update is allowed, otherwise full update):
     ```json
     {
       "front": "string (max 200 chars)",
       "back": "string (max 500 chars)",
       "source": "string (one of: ai-full, ai-edited, manual)"
     }
     ```
   - **Response Payload**: Same structure as flashcard details.
   - **Status Codes**:
     - 200 OK
     - 400 Bad Request
     - 404 Not Found
     - 401 Unauthorized

5. **DELETE /flashcards/{id}**
   - **Description**: Delete an existing flashcard.
   - **Response**: No content or a confirmation message.
   - **Status Codes**:
     - 204 No Content
     - 404 Not Found
     - 401 Unauthorized

6. **GET /study-session**
   - **Description**: Retrieve a set of flashcards to be used in a spaced repetition learning session. This endpoint applies the algorithm to select flashcards.
   - **Response Payload**:
     ```json
     {
       "sessionId": "string",
       "flashcards": [
         {
           "id": "integer",
           "front": "string",
           "back": "string"
         }
       ]
     }
     ```
   - **Status Codes**:
     - 200 OK
     - 401 Unauthorized

### Generations Endpoints

1. **POST /generations**
   - **Description**: Generate flashcard suggestions using an AI model based on input text.
   - **Request Payload**:
     ```json
     {
       "source_text": "string (1000 to 10000 characters)",
       "model": "string (optional, defaults to a configured model)"
     }
     ```
   - **Processing**:
     - Validate the `source_text` length.
     - Call the external LLM API (e.g., Openrouter.ai) to generate flashcard suggestions.
     - Record generation details (counts, source_text_hash, duration) in the `Generations` table.
   - **Response Payload**:
     ```json
     {
       "id": "integer",
       "user_id": "integer",
       "model": "string",
       "generated_count": "integer",
       "flashcards": [
         {
           "front": "string",
           "back": "string",
           "source": "ai-full" /* or ai-edited based on user action */
         }
       ],
       "created_at": "datetime"
     }
     ```
   - **Status Codes**:
     - 201 Created
     - 400 Bad Request (if text length is out of bounds)
     - 500 Internal Server Error (if AI API fails)
     - 401 Unauthorized

2. **GET /generations**
   - **Description**: Retrieve a list of AI generation history for the authenticated user.
   - **Response Payload**: Paginated list with generation details (id, model, counts, timestamps).
   - **Status Codes**:
     - 200 OK
     - 401 Unauthorized

3. **GET /generations/{id}**
   - **Description**: Retrieve detailed information about a specific AI generation, including the flashcard suggestions.
   - **Response Payload**: Same as individual generation details above.
   - **Status Codes**:
     - 200 OK
     - 404 Not Found
     - 401 Unauthorized

### Generation_Error_Logs Endpoints (Optional / Admin)

1. **GET /errors**
   - **Description**: Retrieve error logs related to AI generations. Typically restricted to admin users or the respective user.
   - **Response Payload**:
     ```json
     [
       {
         "id": "integer",
         "model": "string",
         "error_code": "string",
         "error_message": "string",
         "created_at": "datetime"
       }
     ]
     ```
   - **Status Codes**:
     - 200 OK
     - 401 Unauthorized
     - 403 Forbidden (if access is restricted)

## 3. Authentication and Authorization

- **Method**: JWT Bearer authentication is used to secure endpoints. Users receive a JWT upon successful login which must be sent in the `Authorization` header for protected endpoints.
- **Access Control**: 
  - Endpoints related to flashcards, generations, and study sessions require the authenticated user's token.
  - Endpoints ensure that users can only access resources associated with their own accounts.
  - Admin or special access might be required for certain endpoints like viewing generation error logs.

## 4. Validation and Business Logic

- **Database Schema Validations**:
  - **Users**: Email must be unique. Password should meet security criteria.
  - **Flashcards**:
    - `front` is limited to 200 characters.
    - `back` is limited to 500 characters.
    - `source` must be one of the following: 'ai-full', 'ai-edited', or 'manual'.
  - **Generations**:
    - `source_text_length` must be between 1000 and 10000 characters as enforced by a check constraint.

- **Business Logic Mappings**:
  - **User Registration and Login**: Implements basic authentication per the PRD requirements.
  - **AI Flashcard Generation (US-003 & US-004)**:
    - The POST /generations endpoint triggers the external LLM API based on validated input text.
    - Generated flashcards are then returned for review, allowing the user to accept, edit, or reject the suggestions.
    - Accepted suggestions may create entries in the `Flashcards` table, linking them to the specific generation.
  - **Manual Flashcard Management (US-005, US-006, US-007)**: CRUD operations on flashcards allow users to create, modify, or delete flashcards.
  - **Study Session (US-008)**: The GET /study-session endpoint selects flashcards based on a spaced repetition algorithm.
  - **Security (US-009)**: All authenticated endpoints enforce that users can only access and modify their own data.

- **Additional Considerations**:
  - **Pagination, Filtering, and Sorting**: Endpoints returning list data support query parameters to handle large datasets.
  - **Exception Handling**: Consistent error responses are implemented across all endpoints.
  - **Rate Limiting and Throttling**: Implemented via middleware to mitigate abuse.
  - **Integration with External APIs**: The AI generation process handles external API errors gracefully, logging issues to the `Generation_Error_Logs` table.

*Assumptions*:
- The external LLM service (e.g., Openrouter.ai) is integrated using an internal service layer with HttpClient.
- JWT authentication is configured using ASP.NET Core Identity or a similar provider.
- All endpoints leverage EF Core for data access and DI for service management. 